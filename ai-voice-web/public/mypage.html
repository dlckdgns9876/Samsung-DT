<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>마이페이지 - 육아 앱</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <!-- 로그인 상태 표시 영역 -->
    <div id="user-status" class="d-flex justify-content-end align-items-center p-3">
        <!-- JavaScript를 통해 동적으로 내용이 채워집니다 -->
    </div>

    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="text-center my-5">
                    <h1 class="mb-4">마이페이지</h1>
                </div>

                <!-- 회원정보 수정 -->
                <div class="card mb-4 shadow-sm">
                    <div class="card-body">
                        <h2 class="card-title fs-4 mb-3">회원정보 수정</h2>
                        
                        <!-- 닉네임 변경 -->
                        <form id="updateNicknameForm" class="mb-4">
                            <label for="newNickname" class="form-label">새 닉네임</label>
                            <div class="input-group">
                                <input type="text" id="newNickname" class="form-control" placeholder="새 닉네임을 입력하세요" required>
                                <button class="btn btn-outline-primary" type="submit">변경</button>
                            </div>
                        </form>

                        <!-- 비밀번호 변경 -->
                        <form id="updatePasswordForm">
                            <div class="mb-3">
                                <label for="currentPassword" class="form-label">현재 비밀번호</label>
                                <input type="password" id="currentPassword" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label for="newPassword" class="form-label">새 비밀번호</label>
                                <input type="password" id="newPassword" class="form-control" required>
                            </div>
                            <button type="submit" class="btn btn-outline-danger w-100">비밀번호 변경</button>
                        </form>
                    </div>
                </div>
                <div class="text-center">
                    <a href="/" class="btn btn-secondary">메인 페이지로 돌아가기</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        const updateNicknameForm = document.getElementById('updateNicknameForm');
        const updatePasswordForm = document.getElementById('updatePasswordForm');
        const userStatusEl = document.getElementById('user-status');

        // 로그인 상태 UI 업데이트 함수
        const updateLoginStatus = () => {
            const token = localStorage.getItem('token');
            const nickname = localStorage.getItem('nickname');

            if (token && nickname) {
                userStatusEl.innerHTML = `
                    <div class="d-flex align-items-center">
                        <span class="badge bg-primary me-2">${nickname}</span>
                        <span class="text-secondary">님, 환영합니다!</span>
                        <a href="/" class="text-decoration-none text-secondary mx-3">메인 페이지</a>
                        <button id="logoutBtn" class="btn btn-outline-secondary btn-sm">로그아웃</button>
                    </div>
                `;
            } else {
                // 로그인 안된 사용자는 메인 페이지로 리디렉션
                window.location.href = '/';
            }

            // 카카오 로그인 사용자인 경우 비밀번호 변경 폼 숨기기
            const loginType = localStorage.getItem('login_type');
            if (loginType === 'kakao') {
                updatePasswordForm.style.display = 'none';
            }
        };

        // 닉네임 변경 폼 제출
        updateNicknameForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const token = localStorage.getItem('token');
            if (!token) return alert('로그인이 필요합니다.');

            const nickname = document.getElementById('newNickname').value;

            try {
                const res = await fetch('/api/users/nickname', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'x-auth-token': token },
                    body: JSON.stringify({ nickname }),
                });
                const data = await res.json();
                if (!res.ok) throw data;

                localStorage.setItem('nickname', data.nickname);
                updateLoginStatus();
                alert('닉네임이 성공적으로 변경되었습니다.');
                updateNicknameForm.reset();
            } catch (err) {
                alert(`닉네임 변경 실패: ${err.msg || '서버 오류'}`);
            }
        });

        // 비밀번호 변경 폼 제출
        updatePasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const token = localStorage.getItem('token');
            if (!token) return alert('로그인이 필요합니다.');

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;

            try {
                const res = await fetch('/api/users/password', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'x-auth-token': token },
                    body: JSON.stringify({ currentPassword, newPassword }),
                });
                const data = await res.json();
                if (!res.ok) throw data;

                alert(data.msg);
                updatePasswordForm.reset();
            } catch (err) {
                alert(`비밀번호 변경 실패: ${err.msg || '서버 오류'}`);
            }
        });

        // 로그아웃
        userStatusEl.addEventListener('click', (e) => {
            if (e.target.id === 'logoutBtn') {
                localStorage.removeItem('token');
                localStorage.removeItem('nickname');
                localStorage.removeItem('login_type');
                alert('로그아웃 되었습니다.');
                window.location.href = '/';
            }
        });

        // 페이지 로드 시 로그인 상태 확인
        document.addEventListener('DOMContentLoaded', updateLoginStatus);
    </script>
</body>
</html>